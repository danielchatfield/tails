For Tails 2.0 we want at least basic UEFI boot including Mac.

[[!toc levels=2]]

Goals and non-goals
===================

Goals
-----

* devices produced by Tails Installer should boot on most UEFI-only
  hardware (e.g. some relevant set of Macs)
* devices produced by Tails Installer should boot on most hardware
  that only supports UEFI boot for GPT devices (e.g. ThinkPad X220)

Non-goals
---------

* UEFI DVD boot: BIOS boot from DVD works fine on most hardware,
  including Macs; adding the files needed to have UEFI DVD boot work
  on some systems will break what currently works for others.
* UEFI boot from hybrid ISO cat'd on a USB device: given BIOS DVD boot
  works generally fine, it's OK to require users to go this way and
  install their UEFI-capable Tails USB stick from DVD.
* 32-bit UEFI boot: this hardware is rare and mostly obsolete these
  days
* Secure Boot support is not part of this plan. Picking technical
  solutions that leave room for Secure Boot would be a great
  bonus, though.

Resources
=========

* lernstick Grub configuration, implemented as a live-build binary
  hook, that's meant to be nice with an existing syslinux
  configuration managed by live-build:
  <https://github.com/imedias/lernstickAdvanced.git> (oh, and they use
  the [xmlboot](https://github.com/imedias/xmlboot) gfxboot script and
  many crazy Grub configuration scripts)
* [hellais' TAILS-OSX scripts](https://github.com/hellais/TAILS-OSX)
  and the [list of
  hardware](https://github.com/hellais/TAILS-OSX/blob/master/tested-on.md)
  it was tested on
* [Mac Linux USB Loader](http://sevenbits.github.io/Mac-Linux-USB-Loader/)
  Doesn't work with Tails at the moment, but that's a frequent request
  to upstream. Upstream is working on fixing this. That would allow
  starting Tails on Mac UEFI.
* Steve McIntyre's EFI installation progress:
  - [[!debpkg debian-cd]] 3.1.11 has x86 EFI support, see the
    `debian/changelog` for details
  - [fourth](http://blog.einval.com/2012/09/03#Debian_EFI_4) (2012-09-03)
  - [third](http://blog.einval.com/2012/08/24#Debian_EFI_3)
  - [second](http://blog.einval.com/2012/08/22#Debian_EFI_2) (2012-08-22)
  - [first](http://blog.einval.com/2012/08/12#Debian_EFI) (2012-08-12)
* <https://lists.debian.org/debian-devel/2012/01/msg00168.html>
* [Debian: switch to UEFI boot](http://tanguy.ortolo.eu/blog/article51/debian-efi)
* [[!debbug 658352]] about adding UEFI support to Debian CDs
* Liberte Linux supports UEFI (with GRUB, and syslinux for BIOS boot)
* the [SprezzOS](http://www.sprezzatech.com/sprezzos.html)
  Debian derivative is [working on this](https://github.com/dankamongmen/SprezzOS/wiki/Installer) too:
  - [bug 11](https://www.sprezzatech.com/bugs/show_bug.cgi?id=11)
  - [bug 104](https://www.sprezzatech.com/bugs/show_bug.cgi?id=104)
* rEFIt developer, Rod Smith, may be willing to help:
  [[forum/Boot_fails_from_usb_thumb_drive_on_Macbook_Pro]]
* ArchLinux' page about
  [UEFI Bootloaders](https://wiki.archlinux.org/index.php/UEFI_Bootloaders)
* syslinux 6 (released in June 2013) has UEFI support. Debian Live's
  UEFI support will be based on it.
  - Early users [discussion and
    hints](http://www.marshut.com/kyxhm/question-about-syslinux-efi-alpha-version.html).
  - It seems that syslinux does not do very well with CD booting and
    UEFI: a FAT32 ElTorito image (with kernel, initrd and boot loader
    configuration) must be embedded into the ISO9660. syslinux can't
    read any other file system than the one it was booted from, so we
    have to duplicate these files. Also, this image must be smaller
    than 32MB. Indeed,
    [Knoppix](http://www.knopper.net/knoppix/index-en.html) 7.2 uses
    syslinux 6, and supports "UEFI-Boot (DVD: 32 and 64bit, CD: only
    32bit) *after installation on USB flash disk*".
* Kanotix, based on Debian Live and GRUB2, has a isohybrid setup that
  allows "multi-hybrid booting" as CD-ROM (EFI or El Torito) or as
  a hard-drive (e.g. a USB pendrive) on Intel-Macs (EFI) and PCs (EFI
  or MBR). [See
  details](https://mailman.boum.org/pipermail/tails-dev/2013-February/002587.html).
* Debian's Linux 3.2 kernel has "UEFI stub" support, which
  allows it to be started directly since the EFI boot menu.
* Running a UEFI firmware for virtual machines (after installing the
  `ovmf` package): `qemu-system-x86_64 -bios /usr/share/ovmf/OVMF.fd`
* [Booting a Self-signed Linux
  Kernel](http://www.kroah.com/log/blog/2013/09/02/booting-a-self-signed-linux-kernel/),
  by Greg Kroah-Hartman
* [Ubuntu Privacy Remix](https://www.privacy-cd.org/)'s next release
  (UPR 12.04r1) will support UEFI; a beta is available; they copied
  the solution from Ubuntu 13.10 (beta): the shim bootloader and
  a corresponding GRUB binary which passes secure boot. See their
  [build script](https://www.privacy-cd.org/en/tutorials/build-your-own-cd/79).
* [Managing EFI Boot Loaders for Linux by Rod Smith](http://www.rodsbooks.com/efi-bootloaders/index.html)
* Debian's Secure Boot support will be done for GRUB first, unclear if
  other bootloaders will be supported
* shim is not in Debian yet (2013-11-28)

Matthew Garrett:

* [Secure Boot bootloader for distributions available now](http://mjg59.dreamwidth.org/20303.html)
* [An overview of Fedora's Secure Boot implementation](http://mjg59.dreamwidth.org/18945.html)

More technical details:

 * <http://bazaar.launchpad.net/~libburnia-team/libisofs/scdbackup/view/head:/doc/boot_sectors.txt#L398>


Later
=====

EFI boot on Mac without rEFInd
------------------------------

This is not a requirement of ours for the first iteration, but could
be a nice future improvement.

* Mike Hommey's
  [Debian EFI mode boot on a Macbook Pro, without
  rEFIt](http://glandium.org/blog/?p=2830).
* Matthew Garrett detailed [the ISO images for Fedora 17 installation
  CD](http://mjg59.dreamwidth.org/11285.html) and [their Mac
  support](http://mjg59.dreamwidth.org/12037.html): it supports BIOS,
  UEFI, Mac platforms when burned to a CD or written directly to a USB
  stick. This might be nice for the ISO that Tails distribute, but not
  applicable to support USB sticks with incremental updates.

Secure Boot
-----------

* Matthew Garrett's [Handling UEFI Secure Boot in smaller distributions](http://mjg59.dreamwidth.org/17542.html)

Test results
============

Prerequisite: Tails with an amd64 kernel (e.g. from current
experimental branch).

grub-efi
--------

Tested with grub-efi 2.00-22 from Debian unstable.

	sudo apt-get install grub-efi-amd64-bin

	# make the system partition an *EFI System Partition* (ESP)
	parted "$TAILS_DEVICE" set 1 boot on

        MODULES="
           all_video
           bitmap
           bitmap_scale
           boot
           btrfs
           bufio
           cat
           chain
           configfile
           crypto
           echo
           efifwsetup
           efi_gop
           efinet
           efi_uga
           ext2
           extcmd
           fat
           font
           gettext
           gfxmenu
           gfxterm
           gzio
           halt
           hfsplus
           iso9660
           jpeg
           keystatus
           linux
           linuxefi
           loadenv
           memdisk
           minicmd
           normal
           part_apple
           part_gpt
           part_msdos
           password_pbkdf2
           png
           read
           reboot
           search
           search_fs_file
           search_fs_uuid
           search_label
           sleep
           terminal
           test
           trig
           video
           video_fb
        "

	mkdir -p "$TAILS_MOUNTPOINT"/{boot/grub,EFI/BOOT} && \
	   grub-mkimage --output="$TAILS_MOUNTPOINT"/EFI/BOOT/bootx64.efi \
	      --format x86_64-efi $MODULES

	cat > "$TAILS_MOUNTPOINT"/boot/grub/grub.cfg <<EOF
	menuentry Tails --class start {
		echo $"Loading Tails..."
		linux /live/vmlinuz2 initrd=/live/initrd2.img boot=live config live-media=removable nopersistent noprompt timezone=Etc/UTC block.events_dfl_poll_msecs=1000 splash nox11autologin module=Tails quiet
		initrd /live/initrd2.img
	}
	EOF

* boots on ThinkPenguin Royal
* boots on Macbook 13-inch Mid-2012 with rEFInd; one has to choose
  *Fallback boot loader from Tails* in rEFInd, *Boot Linux from Tails*
  does nothing at all

syslinux
--------

Tested with syslinux 6.02+dfsg-1.

	sudo apt-get install syslinux/experimental \
	   syslinux-common/experimental isolinux/experimental

	# make the system partition an *EFI System Partition* (ESP)
	parted "$TAILS_DEVICE" set 1 boot on

	mkdir -p "$TAILS_MOUNTPOINT"/EFI/BOOT && \
	   cp /usr/lib/SYSLINUX/efi64/syslinux.efi \
	      "$TAILS_MOUNTPOINT"/EFI/BOOT/bootx64.efi && \
	   cp "$TAILS_MOUNTPOINT"/syslinux/* "$TAILS_MOUNTPOINT"/EFI/BOOT/ && \
	   /bin/cp -f /usr/lib/syslinux/modules/efi64/* "$TAILS_MOUNTPOINT"/EFI/BOOT/

* boots on ThinkPad X220 (syslinux 6.02+dfsg-1)
* boots on X230 (syslinux 6.02+dfsg-1)
* boots on ThinkPenguin Royal (syslinux 6.02+dfsg-1 and 6.03~pre1+dfsg-1)
* does not boot on MacBook Pro 13-inch Mid 2012 without rEFInd (expected)
* boots on MacBook Pro 13-inch Mid 2012 with rEFInd *if* `menu
  background splash.png` is removed from `stdmenu.cfg`; adding `menu
  resolution 640 480` before `menu background` makes the menu display
  "correctly" (only taking 1/4 of the screen, but oh well), *but* the
  system does not boot
* on MacBook Pro 13-inch Mid 2012 with rEFInd, one has to choose
  *Fallback boot loader from Tails* in rEFInd to boot, as the *Boot
  Linux from Tails* entry does nothing at all (syslinux 6.02+dfsg-1
  and 6.03~pre1+dfsg-1)
* The ThinkPenguin Royal does not detect the bootloader if installed
  as `EFI/Tails/syslinux.efi`; hence the use of the fallback bootloader
  path (`BOOT/bootx64.efi`), which should work on more hardware.
* tails-i386-feature_uefi-0.23-20131222T0855Z-8acf864.iso
  boots fine on a Apple MacBook Air 13" mid 2011 (MacBookAir4,2)
  once installed with Tails Installer
