#!/bin/sh

test -z "$PWD" && exit 1
mkdir -p "$PWD/SFILL"
trap "rm -rf $PWD/SFILL" EXIT

. gettext.sh
TEXTDOMAIN=nautilus-sfill
export TEXTDOMAIN

title="`gettext \"Securely erase free space\"`"

{ (echo 0
MAX=4000000
FREE="$(df -P "$PWD" | awk '/\// { print $4 }')"
if [ "$FREE" -gt "$MAX" ]; then
	for n in $(seq 0 $((90 / ($FREE / $MAX))) 90); do
		echo "$n"
		FILE="$PWD/SFILL/$FREE.$n.$$"
		echo "# `eval_gettext \"Erasing \\\$FILE\"`"
		dd if=/dev/zero of="$FILE" seek="$MAX" bs=1k count=1
		shred -n 3 "$FILE"
	done
	echo 90
fi
echo "# `eval_gettext \"Erasing left free space\"`"
RESULT=$(gksu --description "sfill" "sh -c '
sfill -l -l \"$PWD/SFILL\" &&
sfill -l -l \"$PWD/SFILL\" &&
sfill -l -l \"$PWD/SFILL\" || echo ERROR")
test "$RESULT" = "ERROR" && exit 1
rm -rf "$PWD/SFILL"
echo 100
echo "# `eval_gettext \"Free space was successfully erased.\"`"
) || {
echo "# `eval_gettext \"An error happened.\"`"
zenity --error \
  --text "`gettext \"An error happened while erasing free space.\"`" \
  --title "$title"
} ; } | zenity --progress --title "$title"
