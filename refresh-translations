#! /bin/sh

set -e
set -u

PERL_PROGS="/usr/local/bin/gpgApplet /usr/local/bin/tails-security-check \
   /usr/local/bin/tails-htp-notify-user /usr/local/bin/tails-start-i2p \
   /usr/local/bin/tails-virt-notify-user"
PYTHON_PROGS="/etc/whisperback/config.py /usr/local/bin/shutdown_helper_applet \
   /usr/local/bin/tails-about /usr/local/sbin/tails-additional-software"
SHELL_PROGS="/usr/local/sbin/unsafe-browser"

LANGUAGES=$(for po in po/*.po ; do rel="${po%.po}" ; echo "${rel#po/}"; done)
LOCALE_BASEDIR=config/chroot_local-includes/usr/share/locale
POTFILE=config/chroot_local-includes/usr/share/tails/messages.pot

### Functions

prog_potfile () {
   prog=$1

   progpath="config/chroot_local-includes$prog"
   domain=$(basename $prog)
   sharedir="config/chroot_local-includes/usr/share/${domain}"
   pot="${sharedir}/messages.pot"

   echo $pot
}

refresh_pot () {
   prog=$1
   proglang=$2

   progpath="config/chroot_local-includes$prog"
   pot=$(prog_potfile $prog)

   mkdir -p "$(dirname $pot)"

   if [ -e "${progpath}" ]; then
      xgettext --language="${proglang}" --from-code=UTF-8 \
        -o "${pot}" "${progpath}"
      sed -i "s@^\"Content-Type: text/plain\; charset=CHARSET\\\n\"@\"Content-Type: text/plain\; charset=UTF-8\\\n\"@" "${pot}"
   fi
}

po_file () {
   locale=$1

   echo "po/${locale}.po"
}

mo_file () {
   locale=$1

   echo "${LOCALE_BASEDIR}/${locale}/LC_MESSAGES/tails.mo"
}

concat_pot_files () {
   msgcat --to-code=UTF-8 \
      $(for prog in $@ ; do echo -n "$(prog_potfile $prog) " ; done)
}

refresh_po () {
   pot=$1 ; shift
   for locale in "$@" ; do
      po=$(po_file $locale)
      mkdir -p $(dirname "$po")
      [ -e "${po}" ] || cp "${pot}" "${po}"
      msgmerge --update "${po}" "${pot}"
   done
}

refresh_mo () {
   for locale in "$@" ; do
      po=$(po_file $locale)
      mo=$(mo_file $locale)
      mkdir -p $(dirname "$mo")
      msgfmt -o "${mo}" "${po}"
   done
}

no_left_out_files () {
   (cd po && intltool-update --maintain)
   [ ! -e po/missing ] || return 1
   return 0
}

intltool_update () {
   cd po
   intltool-update -x --pot --gettext-package=tails
   for locale in "$@" ; do
      intltool-update --dist --gettext-package=tails $locale
   done
}

### Main

mkdir -p $(dirname $POTFILE)

for prog in $PERL_PROGS   ; do refresh_pot $prog Perl   ; done
for prog in $PYTHON_PROGS ; do refresh_pot $prog Python ; done
for prog in $SHELL_PROGS  ; do refresh_pot $prog Shell  ; done

# If left out files are detected, intltool-update --maintain writes
# them to po/missing.
no_left_out_files || exit 3

concat_pot_files $PERL_PROGS $PYTHON_PROGS $SHELL_PROGS > $POTFILE

refresh_po $POTFILE $LANGUAGES
refresh_mo $LANGUAGES

intltool_update $LANGUAGES

